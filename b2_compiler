#!/usr/bin/env bash

ROOT="$(dirname "$0")"
if [[ ${ROOT:0:1} != / ]]
then
	ROOT="$PWD/$ROOT"
fi

cd "$1"

on_exit()
{
	rm -rf "$tmp" "$tmpdir"
}
trap on_exit EXIT INT TERM

# TODO Linux only
tmpdir="$(mktemp -d)"

compile()
{
	echo "$@"
	FULL_NAME="$1"
	NAME="$(basename "$1")"
	FILE="$(basename "$2")"
	shift 2
	if ! "$@"
	then
		return 1
	fi
	case `uname` in
		Linux) tmp="$(mktemp)" ;;
		FreeBSD) tmp="$(mktemp -t /tmp)" ;;
		*) echo "Unknown system type" && exit 1;;
	esac
	cp -p "$FULL_NAME/conf.txt" "$tmp"
	case `uname` in
		Linux) sed -r -i "s|^checker=.*$|checker=check_new|" "$FULL_NAME/conf.txt" ;;
		FreeBSD) sed -r -i "" -e "s|^checker=.*$|checker=check_new|" "$FULL_NAME/conf.txt" ;;
		*) echo "Unknown system type" && exit 1;;
	esac
	touch -m -r "$tmp" "$FULL_NAME/conf.txt"
	return 0
}

TESTLIB_CPP="$ROOT/testlib/cpp/01_testlib.googlecode.com"
TESTLIB_PAS="$ROOT/testlib/pas"

pascal_select()
{
	i="$2"
	for tl in "$TESTLIB_PAS/"*
	do
		compile "$1" "$i" fpc -O2 -Cs`echo '64*2^20-1025' | bc` -Fu"$tl" -I"$tl" -FU"$tmpdir" -Mdelphi "$i" -ocheck_new && echo "$tl" && return 0
	done
	return 1
}

if [ -d "checker" ]
then
	check_name="$(egrep '^checker=' conf.txt | sed -r 's|^checker=||')"
	cd "checker"
	rm -f check_new *.o *.ppu
	for i in *.*
	do
		case $i in
			*.cpp) compile "$1" "$i" g++ "$i" -O2 -ocheck_new -I"$TESTLIB_CPP" && break ;;
			*.c) compile "$1" "$i" gcc "$i" -O2 -ocheck_new && break ;;
			*.dpr) true ;&
			*.pas) pascal_select "$1" "$i" && break;;
			*.exe) ;;
			*.old) ;;
			'*.*') ;;
			*.cs) compile "$1" "$i" false ;;
			*) compile "$1" "$i" false && exit 1 ;;
		esac
	done
	rm -f *.o *.ppu
fi

